<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Congressional Trading Intelligence - Live Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
        }
        
        .header {
            background: linear-gradient(135deg, #1e1b4b 0%, #581c87 50%, #312e81 100%);
            color: #f1f5f9;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 1.5rem 0;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .header p {
                font-size: 0.875rem;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 1rem 0;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
        
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 0 1rem; 
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 0.5rem;
            }
        }
        
        .system-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(139, 92, 246, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        @media (max-width: 768px) {
            .system-status {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(139, 92, 246, 0.3);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #8b5cf6;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #cbd5e1;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .tab-navigation {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 1rem;
            margin: 2rem 0;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .tab-buttons {
                justify-content: center;
            }
            
            .tab-button {
                padding: 0.6rem 1rem;
                font-size: 0.875rem;
            }
        }
        
        @media (max-width: 480px) {
            .tab-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .tab-button {
                width: 100%;
                text-align: center;
            }
        }
        
        .tab-button {
            padding: 0.75rem 1.5rem;
            border: 2px solid rgba(139, 92, 246, 0.3);
            background: linear-gradient(145deg, #374151 0%, #4b5563 100%);
            color: #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover, .tab-button.active {
            background: linear-gradient(145deg, #8b5cf6 0%, #7c3aed 100%);
            border-color: #8b5cf6;
            transform: translateY(-2px);
        }
        
        .tab-content {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(139, 92, 246, 0.2);
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chart-container {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            min-height: 300px;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                min-height: 250px;
                padding: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .chart-container {
                min-height: 200px;
                padding: 0.5rem;
            }
        }
        
        .action-button {
            background: linear-gradient(145deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-radius: 50%;
            border-top-color: #8b5cf6;
            animation: spin 1s ease-in-out infinite;
        }
        
        .offline-indicator {
            background: rgba(107, 114, 128, 0.2);
            border: 1px solid rgba(107, 114, 128, 0.4);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.875rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
        }
        
        @media (max-width: 480px) {
            .data-table {
                font-size: 0.75rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 4px;
            }
        }
        
        .data-table th {
            background: rgba(139, 92, 246, 0.1);
            font-weight: 600;
            color: #8b5cf6;
        }
        
        .data-table tr:hover {
            background: rgba(139, 92, 246, 0.05);
        }
        
        .risk-score {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        
        .risk-low { background: #10b981; color: white; }
        .risk-medium { background: #f59e0b; color: white; }
        .risk-high { background: #ef4444; color: white; }
        .risk-extreme { background: #dc2626; color: white; }
        
        .status-connecting { color: #f59e0b; }
        .status-offline { color: #6b7280; }
        .status-error { color: #ef4444; }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .filter-controls {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
        
        .filter-control {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-control label {
            font-size: 0.875rem;
            color: #cbd5e1;
        }
        
        .filter-control select,
        .filter-control input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            background: rgba(30, 41, 59, 0.5);
            color: #e2e8f0;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            animation: slideIn 0.3s ease;
        }
        
        .warning-message {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            animation: slideIn 0.3s ease;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }
        
        .data-card {
            background: rgba(30, 41, 59, 0.3);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8b5cf6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Congressional Trading Intelligence System</h1>
            <p>Live Data Dashboard - Connected to Enhanced Backend</p>
        </div>
        
        <!-- System Status -->
        <div class="system-status">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>System Status: <span id="system-status">Connecting...</span></span>
            </div>
            <div class="status-indicator">
                <span>Last Updated: <span id="last-updated">--</span></span>
            </div>
            <div class="status-indicator">
                <button class="action-button" onclick="refreshAllData()" id="refresh-btn">
                    üîÑ Refresh Data
                </button>
            </div>
        </div>
        
        <!-- Live Statistics -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-members">Loading...</div>
                <div class="stat-label">Congressional Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-trades">Loading...</div>
                <div class="stat-label">Total Trades Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-volume">Loading...</div>
                <div class="stat-label">Total Trading Volume</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-risk-score">Loading...</div>
                <div class="stat-label">Average Risk Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="high-risk-count">Loading...</div>
                <div class="stat-label">High-Risk Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="compliance-rate">Loading...</div>
                <div class="stat-label">Compliance Rate</div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('member-analysis')">
                    üë• Member Analysis
                </button>
                <button class="tab-button" onclick="showTab('trade-explorer')">
                    üìä Trade Explorer
                </button>
                <button class="tab-button" onclick="showTab('ml-predictions')">
                    ü§ñ ML Predictions
                </button>
                <button class="tab-button" onclick="showTab('anomaly-detection')">
                    üö® Anomaly Detection
                </button>
                <button class="tab-button" onclick="showTab('statistical-analysis')">
                    üìà Statistical Analysis
                </button>
                <button class="tab-button" onclick="showTab('data-export')">
                    üìÅ Data Export
                </button>
            </div>
        </div>
        
        <!-- Member Analysis Tab -->
        <div id="member-analysis" class="tab-content active">
            <h2>üë• Congressional Member Analysis</h2>
            
            <div class="filter-controls">
                <div class="filter-control">
                    <label for="party-filter">Party</label>
                    <select id="party-filter" onchange="filterMembers()">
                        <option value="">All Parties</option>
                        <option value="D">Democrat</option>
                        <option value="R">Republican</option>
                        <option value="I">Independent</option>
                    </select>
                </div>
                <div class="filter-control">
                    <label for="chamber-filter">Chamber</label>
                    <select id="chamber-filter" onchange="filterMembers()">
                        <option value="">All Chambers</option>
                        <option value="House">House</option>
                        <option value="Senate">Senate</option>
                    </select>
                </div>
                <div class="filter-control">
                    <label for="risk-filter">Minimum Risk Score</label>
                    <input type="number" id="risk-filter" min="0" max="10" step="0.1" 
                           placeholder="0.0" onchange="filterMembers()">
                </div>
                <div class="filter-control">
                    <label for="limit-filter">Results Limit</label>
                    <select id="limit-filter" onchange="filterMembers()">
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
            
            <div>
                <button class="action-button" onclick="loadMemberData()">
                    üìä Load Member Data
                </button>
                <button class="action-button" onclick="analyzeRiskPatterns()">
                    üéØ Analyze Risk Patterns
                </button>
                <button class="action-button" onclick="generateMemberReport()">
                    üìÑ Generate Report
                </button>
            </div>
            
            <div id="member-results">
                <div class="chart-container">
                    <canvas id="memberChart" width="400" height="200"></canvas>
                </div>
                
                <div id="member-table-container">
                    <table class="data-table" id="member-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Party</th>
                                <th>State</th>
                                <th>Chamber</th>
                                <th>Risk Score</th>
                                <th>Trade Count</th>
                                <th>Avg Amount</th>
                                <th>Avg Delay</th>
                            </tr>
                        </thead>
                        <tbody id="member-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Trade Explorer Tab -->
        <div id="trade-explorer" class="tab-content">
            <h2>üìä Trade Explorer</h2>
            
            <div class="filter-controls">
                <div class="filter-control">
                    <label for="member-search">Member Name</label>
                    <input type="text" id="member-search" placeholder="Search member...">
                </div>
                <div class="filter-control">
                    <label for="symbol-search">Stock Symbol</label>
                    <input type="text" id="symbol-search" placeholder="e.g., AAPL">
                </div>
                <div class="filter-control">
                    <label for="min-amount">Min Amount</label>
                    <input type="number" id="min-amount" placeholder="0">
                </div>
                <div class="filter-control">
                    <label for="start-date">Start Date</label>
                    <input type="date" id="start-date">
                </div>
                <div class="filter-control">
                    <label for="end-date">End Date</label>
                    <input type="date" id="end-date">
                </div>
            </div>
            
            <div>
                <button class="action-button" onclick="searchTrades()">
                    üîç Search Trades
                </button>
                <button class="action-button" onclick="analyzeTiming()">
                    ‚è∞ Analyze Timing
                </button>
                <button class="action-button" onclick="detectInsiderTrading()">
                    üö® Detect Patterns
                </button>
            </div>
            
            <div id="trade-results">
                <div class="chart-container">
                    <canvas id="tradeChart" width="400" height="200"></canvas>
                </div>
                
                <div id="trade-table-container">
                    <table class="data-table" id="trade-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Symbol</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount Range</th>
                                <th>Filing Delay</th>
                                <th>Compliance</th>
                            </tr>
                        </thead>
                        <tbody id="trade-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ML Predictions Tab -->
        <div id="ml-predictions" class="tab-content">
            <h2>ü§ñ Machine Learning Predictions</h2>
            
            <div class="data-grid">
                <div class="data-card">
                    <h3>Model Performance</h3>
                    <div id="model-performance">Loading model metrics...</div>
                </div>
                <div class="data-card">
                    <h3>Feature Importance</h3>
                    <div id="feature-importance">Loading feature analysis...</div>
                </div>
            </div>
            
            <div>
                <button class="action-button" onclick="generatePredictions()">
                    ü§ñ Generate Predictions
                </button>
                <button class="action-button" onclick="validateModels()">
                    ‚úÖ Validate Models
                </button>
                <button class="action-button" onclick="forecastImpact()">
                    üìà Forecast Impact
                </button>
            </div>
            
            <div id="prediction-results">
                <div class="chart-container">
                    <canvas id="predictionChart" width="400" height="200"></canvas>
                </div>
                
                <div id="prediction-table-container">
                    <table class="data-table" id="prediction-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Risk Probability</th>
                                <th>Prediction</th>
                                <th>Confidence</th>
                                <th>Model Used</th>
                            </tr>
                        </thead>
                        <tbody id="prediction-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Anomaly Detection Tab -->
        <div id="anomaly-detection" class="tab-content">
            <h2>üö® Anomaly Detection</h2>
            
            <div class="data-grid">
                <div class="data-card">
                    <h3>Detection Statistics</h3>
                    <div id="anomaly-stats">Loading anomaly statistics...</div>
                </div>
                <div class="data-card">
                    <h3>Detection Methods</h3>
                    <div id="detection-methods">
                        <ul>
                            <li>Isolation Forest</li>
                            <li>One-Class SVM</li>
                            <li>Statistical Outlier Detection</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div>
                <button class="action-button" onclick="scanAnomalies()">
                    üîç Scan for Anomalies
                </button>
                <button class="action-button" onclick="analyzeAnomalyPatterns()">
                    üìä Analyze Patterns
                </button>
                <button class="action-button" onclick="generateAnomalyReport()">
                    üìÑ Generate Report
                </button>
            </div>
            
            <div id="anomaly-results">
                <div class="chart-container">
                    <canvas id="anomalyChart" width="400" height="200"></canvas>
                </div>
                
                <div id="anomaly-table-container">
                    <table class="data-table" id="anomaly-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Symbol</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Anomaly Score</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="anomaly-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Statistical Analysis Tab -->
        <div id="statistical-analysis" class="tab-content">
            <h2>üìà Statistical Analysis</h2>
            
            <div class="data-grid">
                <div class="data-card">
                    <h3>Party Comparison</h3>
                    <div id="party-analysis">Loading party analysis...</div>
                </div>
                <div class="data-card">
                    <h3>Chamber Comparison</h3>
                    <div id="chamber-analysis">Loading chamber analysis...</div>
                </div>
                <div class="data-card">
                    <h3>Temporal Patterns</h3>
                    <div id="temporal-analysis">Loading temporal patterns...</div>
                </div>
                <div class="data-card">
                    <h3>Correlation Analysis</h3>
                    <div id="correlation-analysis">Loading correlations...</div>
                </div>
            </div>
            
            <div>
                <button class="action-button" onclick="runStatisticalTests()">
                    üî¨ Run Statistical Tests
                </button>
                <button class="action-button" onclick="analyzeCorrelations()">
                    üîó Analyze Correlations
                </button>
                <button class="action-button" onclick="generateStatReport()">
                    üìä Generate Report
                </button>
            </div>
            
            <div id="statistical-results">
                <div class="chart-container">
                    <canvas id="statisticalChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Data Export Tab -->
        <div id="data-export" class="tab-content">
            <h2>üìÅ Data Export</h2>
            
            <div class="data-grid">
                <div class="data-card">
                    <h3>Export Members Data</h3>
                    <p>Export congressional member information with risk scores</p>
                    <button class="action-button" onclick="exportData('csv', 'members')">
                        üìä Export CSV
                    </button>
                    <button class="action-button" onclick="exportData('json', 'members')">
                        üìù Export JSON
                    </button>
                </div>
                
                <div class="data-card">
                    <h3>Export Trading Data</h3>
                    <p>Export all trading transactions with analysis</p>
                    <button class="action-button" onclick="exportData('csv', 'trades')">
                        üìä Export CSV
                    </button>
                    <button class="action-button" onclick="exportData('json', 'trades')">
                        üìù Export JSON
                    </button>
                </div>
                
                <div class="data-card">
                    <h3>Export Analysis Results</h3>
                    <p>Export comprehensive analysis and statistics</p>
                    <button class="action-button" onclick="exportData('csv', 'analysis')">
                        üìä Export CSV
                    </button>
                    <button class="action-button" onclick="exportData('json', 'analysis')">
                        üìù Export JSON
                    </button>
                </div>
                
                <div class="data-card">
                    <h3>Generate Comprehensive Report</h3>
                    <p>Generate complete analysis report with insights</p>
                    <button class="action-button" onclick="generateComprehensiveReport()">
                        üìÑ Generate Report
                    </button>
                </div>
            </div>
            
            <div id="export-status"></div>
        </div>
    </div>

    <script>
        // Global configuration
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://127.0.0.1:5001' 
            : window.location.origin; // Use backend port for local dev, current origin for production
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
        
        // Global data cache
        let dataCache = {
            stats: null,
            members: null,
            trades: null,
            predictions: null,
            anomalies: null,
            lastUpdate: null
        };
        
        // Global chart instances
        let charts = {};
        
        // API utility functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            try {
                console.log(`[${requestId}] Making API request to: ${url}`);
                showLoading(true, `Loading ${endpoint.split('/').pop()}...`);
                
                // Add timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-ID': requestId,
                        ...options.headers
                    },
                    signal: controller.signal,
                    ...options
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(`[${requestId}] API response:`, data);
                
                // Handle different response formats - some endpoints return success flag, others don't
                if (data.hasOwnProperty('success') && !data.success) {
                    throw new Error(data.error || 'API request failed');
                }
                
                return data;
                
            } catch (error) {
                console.error(`[${requestId}] API Error:`, error);
                
                if (error.name === 'AbortError') {
                    showError('Request timed out - please try again');
                    throw new Error('Request timeout');
                } else if (error.message.includes('Failed to fetch')) {
                    showError('Connection failed - please check if the backend is running');
                    throw new Error('Connection failed');
                } else {
                    showError(`API Error: ${error.message}`);
                    throw error;
                }
            } finally {
                showLoading(false);
            }
        }
        
        // System status and loading
        function showLoading(show, message = 'Loading...') {
            const refreshBtn = document.getElementById('refresh-btn');
            if (show) {
                refreshBtn.innerHTML = `<div class="loading"></div> ${message}`;
                refreshBtn.disabled = true;
                
                // Add loading overlay to current active tab
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && !activeTab.querySelector('.loading-overlay')) {
                    const overlay = document.createElement('div');
                    overlay.className = 'loading-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(30, 41, 59, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #e2e8f0;
                        font-size: 1.2rem;
                        z-index: 1000;
                        backdrop-filter: blur(4px);
                    `;
                    overlay.innerHTML = `<div><div class="loading"></div> ${message}</div>`;
                    activeTab.style.position = 'relative';
                    activeTab.appendChild(overlay);
                }
            } else {
                refreshBtn.innerHTML = 'üîÑ Refresh Data';
                refreshBtn.disabled = false;
                
                // Remove loading overlays
                document.querySelectorAll('.loading-overlay').forEach(overlay => {
                    overlay.remove();
                });
            }
        }
        
        function showError(message) {
            // Remove existing error messages first
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <strong>‚ùå Error:</strong> ${message}
                <button style="float: right; background: transparent; border: none; color: inherit; cursor: pointer; font-size: 1.2em;" 
                        onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // Insert after header
            const header = document.querySelector('.header');
            header.parentNode.insertBefore(errorDiv, header.nextSibling);
            
            // Remove after 8 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 8000);
            
            // Also log to console for debugging
            console.error('Dashboard Error:', message);
        }
        
        function showSuccess(message) {
            // Remove existing success messages first
            document.querySelectorAll('.success-message').forEach(el => el.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `
                <strong>‚úÖ Success:</strong> ${message}
                <button style="float: right; background: transparent; border: none; color: inherit; cursor: pointer; font-size: 1.2em;" 
                        onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // Insert after header
            const header = document.querySelector('.header');
            header.parentNode.insertBefore(successDiv, header.nextSibling);
            
            // Remove after 4 seconds
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 4000);
            
            // Also log to console
            console.log('Dashboard Success:', message);
        }
        
        function showWarning(message) {
            // Remove existing warning messages first
            document.querySelectorAll('.warning-message').forEach(el => el.remove());
            
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning-message';
            warningDiv.innerHTML = `
                <strong>‚ö†Ô∏è Warning:</strong> ${message}
                <button style="float: right; background: transparent; border: none; color: inherit; cursor: pointer; font-size: 1.2em;" 
                        onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // Insert after header
            const header = document.querySelector('.header');
            header.parentNode.insertBefore(warningDiv, header.nextSibling);
            
            // Remove after 6 seconds
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.remove();
                }
            }, 6000);
            
            // Also log to console
            console.warn('Dashboard Warning:', message);
        }
        
        // Tab navigation
        function showTab(tabId) {
            try {
                console.log(`Switching to tab: ${tabId}`);
                
                // Hide all tab contents
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Remove active class from all buttons
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => button.classList.remove('active'));
                
                // Show selected tab and activate button
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                    
                    // Find and activate the corresponding button
                    const activeButton = Array.from(tabButtons).find(button => 
                        button.onclick && button.onclick.toString().includes(tabId)
                    );
                    if (activeButton) {
                        activeButton.classList.add('active');
                    } else if (event?.target) {
                        event.target.classList.add('active');
                    }
                    
                    // Initialize tab-specific data
                    initializeTab(tabId);
                } else {
                    console.error(`Tab with ID '${tabId}' not found`);
                    showError(`Tab '${tabId}' not found`);
                }
            } catch (error) {
                console.error('Error switching tabs:', error);
                showError('Failed to switch tabs');
            }
        }
        
        async function initializeTab(tabId) {
            try {
                switch(tabId) {
                    case 'member-analysis':
                        await loadMemberData();
                        break;
                    case 'trade-explorer':
                        // Trade data loaded on demand
                        break;
                    case 'ml-predictions':
                        await generatePredictions();
                        break;
                    case 'anomaly-detection':
                        await scanAnomalies();
                        break;
                    case 'statistical-analysis':
                        await runStatisticalTests();
                        break;
                    default:
                        console.log(`No initialization needed for tab: ${tabId}`);
                }
            } catch (error) {
                console.error(`Failed to initialize tab ${tabId}:`, error);
                showError(`Failed to load ${tabId} data - using cached data if available`);
                
                // Try to use cached data if available
                if (dataCache[tabId.replace('-', '')]) {
                    showSuccess(`Using cached data for ${tabId}`);
                }
            }
        }
        
        // System initialization
        async function initializeSystem() {
            let connectionAttempts = 0;
            const maxAttempts = 3;
            
            while (connectionAttempts < maxAttempts) {
                try {
                    connectionAttempts++;
                    console.log(`Connection attempt ${connectionAttempts}/${maxAttempts}`);
                    
                    // Check system health with timeout
                    const healthResponse = await fetch(`${API_BASE_URL}/health`, {
                        signal: AbortSignal.timeout(10000) // 10 second timeout
                    });
                    
                    if (!healthResponse.ok) {
                        throw new Error(`Health check failed: ${healthResponse.status}`);
                    }
                    
                    const health = await healthResponse.json();
                    
                    document.getElementById('system-status').textContent = 
                        health.status === 'healthy' ? 'Connected ‚úÖ' : 'Issues Detected ‚ö†Ô∏è';
                    
                    // Load initial statistics
                    await loadSystemStats();
                    
                    document.getElementById('last-updated').textContent = 
                        formatDate(new Date().toISOString(), { includeTime: true });
                    
                    showSuccess('Dashboard connected successfully');
                    return; // Success - exit retry loop
                    
                } catch (error) {
                    console.error(`System initialization attempt ${connectionAttempts} failed:`, error);
                    
                    if (connectionAttempts >= maxAttempts) {
                        // Final failure - activate offline mode
                        activateOfflineMode();
                    } else {
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        showError(`Connection attempt ${connectionAttempts} failed, retrying...`);
                    }
                }
            }
        }
        
        function activateOfflineMode() {
            document.getElementById('system-status').textContent = 'Offline Mode ‚ö†Ô∏è';
            document.getElementById('last-updated').textContent = 'System offline';
            
            showError('Dashboard is in offline mode - backend service unavailable');
            
            // Set all stat cards to offline state
            const statCards = ['total-members', 'total-trades', 'total-volume', 'avg-risk-score', 'high-risk-count', 'compliance-rate'];
            statCards.forEach(cardId => {
                const element = document.getElementById(cardId);
                if (element) {
                    element.textContent = 'Offline';
                    element.parentElement.style.opacity = '0.6';
                }
            });
            
            // Disable refresh button temporarily
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.innerHTML = '‚ö†Ô∏è Offline';
            refreshBtn.disabled = true;
            
            // Re-enable after 10 seconds for retry
            setTimeout(() => {
                refreshBtn.innerHTML = 'üîÑ Retry Connection';
                refreshBtn.disabled = false;
            }, 10000);
        }
        
        // Load system statistics
        async function loadSystemStats() {
            try {
                const response = await apiRequest('/api/v1/stats');
                const stats = response.statistics || response.data?.statistics || response;
                
                // Calculate total volume from monthly data if available
                let totalVolume = stats.total_trading_volume;
                if (!totalVolume && stats.monthly_volume) {
                    totalVolume = Object.values(stats.monthly_volume).reduce((sum, vol) => sum + vol, 0);
                }
                
                // Calculate total trades if not directly available
                let totalTrades = stats.total_trades;
                if (!totalTrades && stats.chamber_breakdown) {
                    totalTrades = Object.values(stats.chamber_breakdown).reduce((sum, count) => sum + count, 0);
                }
                
                // Update stat cards with better fallbacks
                document.getElementById('total-members').textContent = 
                    (stats.total_members_tracked || stats.members_loaded || 'N/A').toLocaleString?.() || 'N/A';
                
                document.getElementById('total-trades').textContent = 
                    (totalTrades || stats.trades_loaded || 'N/A').toLocaleString?.() || 'N/A';
                
                document.getElementById('total-volume').textContent = 
                    totalVolume ? `$${(totalVolume / 1000000).toFixed(1)}M` : 'N/A';
                
                document.getElementById('avg-risk-score').textContent = 
                    stats.average_risk_score ? stats.average_risk_score.toFixed(2) : 'N/A';
                
                document.getElementById('high-risk-count').textContent = 
                    (stats.high_risk_members || 'N/A').toLocaleString?.() || 'N/A';
                
                document.getElementById('compliance-rate').textContent = 
                    stats.compliance_rate ? `${stats.compliance_rate.toFixed(1)}%` : 'N/A';
                
                // Cache the data
                dataCache.stats = response;
                dataCache.lastUpdate = new Date();
                
            } catch (error) {
                console.error('Failed to load system stats:', error);
                showError('Failed to load statistics - displaying cached or default values');
                
                // Set fallback values
                document.getElementById('total-members').textContent = 'Loading...';
                document.getElementById('total-trades').textContent = 'Loading...';
                document.getElementById('total-volume').textContent = 'Loading...';
                document.getElementById('avg-risk-score').textContent = 'Loading...';
                document.getElementById('high-risk-count').textContent = 'Loading...';
                document.getElementById('compliance-rate').textContent = 'Loading...';
            }
        }
        
        // Member Analysis Functions
        async function loadMemberData() {
            const party = document.getElementById('party-filter').value;
            const chamber = document.getElementById('chamber-filter').value;
            const minRisk = document.getElementById('risk-filter').value;
            const limit = document.getElementById('limit-filter').value;
            
            const params = new URLSearchParams();
            if (party) params.append('party', party);
            if (chamber) params.append('chamber', chamber);
            if (minRisk) params.append('min_risk', minRisk);
            if (limit) params.append('limit', limit);
            
            try {
                const response = await apiRequest(`/api/v1/members?${params}`);
                const members = response.data?.members || response.members || [];
                
                // Update member table
                const tableBody = document.getElementById('member-table-body');
                const table = document.getElementById('member-table');
                
                tableBody.innerHTML = '';
                
                if (members.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #cbd5e1;">No members found with the specified criteria</td></tr>';
                } else {
                    members.forEach(member => {
                        const row = document.createElement('tr');
                        
                        const riskScore = member.risk_score || 0;
                        const riskClass = 
                            riskScore >= 9 ? 'risk-extreme' :
                            riskScore >= 7 ? 'risk-high' :
                            riskScore >= 4 ? 'risk-medium' : 'risk-low';
                        
                        row.innerHTML = `
                            <td>${member.name || 'Unknown'}</td>
                            <td>${member.party || 'N/A'}</td>
                            <td>${member.state || 'N/A'}</td>
                            <td>${member.chamber || 'N/A'}</td>
                            <td><span class="risk-score ${riskClass}">${riskScore.toFixed(1)}</span></td>
                            <td>${(member.trade_count || 0).toLocaleString()}</td>
                            <td>$${(member.avg_trade_amount || 0).toLocaleString()}</td>
                            <td>${(member.avg_filing_delay || 0).toFixed(1)} days</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
                
                table.style.display = 'table';
                
                // Create risk distribution chart
                createMemberRiskChart(members);
                
                showSuccess(`Loaded ${members.length} congressional members`);
                
                // Cache the data
                dataCache.members = response;
                
            } catch (error) {
                console.error('Failed to load member data:', error);
                showError('Failed to load member data - please check your connection and try again');
                
                // Show empty table with error message
                const tableBody = document.getElementById('member-table-body');
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #ef4444;">Failed to load member data</td></tr>';
                document.getElementById('member-table').style.display = 'table';
            }
        }
        
        function createMemberRiskChart(members) {
            const canvas = document.getElementById('memberChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.memberChart) {
                charts.memberChart.destroy();
            }
            
            if (!members || members.length === 0) {
                createEmptyMemberChart();
                return;
            }
            
            // Calculate risk distribution with better handling
            const riskDistribution = {
                'Low (0-3)': 0,
                'Medium (4-6)': 0,
                'High (7-8)': 0,
                'Extreme (9-10)': 0
            };
            
            const partyBreakdown = { 'D': 0, 'R': 0, 'I': 0, 'Other': 0 };
            
            members.forEach(member => {
                const risk = member.risk_score || 0;
                if (risk <= 3) riskDistribution['Low (0-3)']++;
                else if (risk <= 6) riskDistribution['Medium (4-6)']++;
                else if (risk <= 8) riskDistribution['High (7-8)']++;
                else riskDistribution['Extreme (9-10)']++;
                
                const party = member.party || 'Other';
                if (partyBreakdown.hasOwnProperty(party)) {
                    partyBreakdown[party]++;
                } else {
                    partyBreakdown['Other']++;
                }
            });
            
            // Create dual chart - risk distribution and party breakdown
            charts.memberChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(riskDistribution),
                    datasets: [{
                        label: 'Risk Distribution',
                        data: Object.values(riskDistribution),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#dc2626'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Member Risk Distribution (${members.length} Members)`,
                            color: '#e2e8f0',
                            font: { size: 14 }
                        },
                        legend: { 
                            labels: { 
                                color: '#e2e8f0',
                                usePointStyle: true
                            },
                            position: 'bottom'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#8b5cf6',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} members (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '40%'
                }
            });
        }
        
        function createEmptyMemberChart() {
            const canvas = document.getElementById('memberChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.memberChart) {
                charts.memberChart.destroy();
            }
            
            charts.memberChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data Available'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#6b7280']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'No Member Data Available',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    }
                }
            });
        }
        
        function filterMembers() {
            loadMemberData();
        }
        
        function analyzeRiskPatterns() {
            showSuccess('Risk pattern analysis initiated - check member table for updated scores');
            loadMemberData();
        }
        
        function generateMemberReport() {
            exportData('json', 'members');
        }
        
        // Trade Explorer Functions
        async function searchTrades() {
            const member = document.getElementById('member-search').value;
            const symbol = document.getElementById('symbol-search').value;
            const minAmount = document.getElementById('min-amount').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            const params = new URLSearchParams();
            if (member) params.append('member', member);
            if (symbol) params.append('symbol', symbol);
            if (minAmount) params.append('min_amount', minAmount);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            params.append('limit', '100');
            
            try {
                const response = await apiRequest(`/api/v1/trades?${params}`);
                const trades = response.data?.trades || response.trades || [];
                
                // Update trade table
                const tableBody = document.getElementById('trade-table-body');
                const table = document.getElementById('trade-table');
                
                tableBody.innerHTML = '';
                
                if (trades.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #cbd5e1;">No trades found matching your criteria</td></tr>';
                } else {
                    trades.forEach(trade => {
                        const row = document.createElement('tr');
                        
                        const complianceStatus = trade.compliance_status || 'UNKNOWN';
                        const complianceClass = 
                            complianceStatus === 'LATE' ? 'risk-high' :
                            complianceStatus === 'WARNING' ? 'risk-medium' : 'risk-low';
                        
                        // Format amount ranges
                        const amountFrom = trade.amount_from || trade.min_amount || 0;
                        const amountTo = trade.amount_to || trade.max_amount || amountFrom;
                        const amountRange = amountFrom === amountTo ? 
                            `$${amountFrom.toLocaleString()}` : 
                            `$${amountFrom.toLocaleString()} - $${amountTo.toLocaleString()}`;
                        
                        row.innerHTML = `
                            <td>${trade.member_name || 'Unknown'}</td>
                            <td>${trade.symbol || 'N/A'}</td>
                            <td>${trade.transaction_date || 'N/A'}</td>
                            <td>${trade.transaction_type || trade.type || 'N/A'}</td>
                            <td>${amountRange}</td>
                            <td>${trade.filing_delay_days || trade.delay_days || 0} days</td>
                            <td><span class="risk-score ${complianceClass}">${complianceStatus}</span></td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
                
                table.style.display = 'table';
                
                // Create trade volume chart
                createTradeVolumeChart(trades);
                
                showSuccess(`Found ${trades.length} matching trades`);
                
                // Cache the data
                dataCache.trades = response;
                
            } catch (error) {
                console.error('Failed to search trades:', error);
                showError('Failed to load trade data - please check your search criteria and try again');
                
                // Show empty table with error message
                const tableBody = document.getElementById('trade-table-body');
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Failed to load trade data</td></tr>';
                document.getElementById('trade-table').style.display = 'table';
            }
        }
        
        function createTradeVolumeChart(trades) {
            const canvas = document.getElementById('tradeChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.tradeChart) {
                charts.tradeChart.destroy();
            }
            
            if (!trades || trades.length === 0) {
                createEmptyTradeChart();
                return;
            }
            
            // Group trades by month with better data handling
            const monthlyVolume = {};
            const monthlyCount = {};
            
            trades.forEach(trade => {
                const date = trade.transaction_date || trade.date;
                if (!date) return;
                
                const month = date.substring(0, 7); // YYYY-MM format
                if (!monthlyVolume[month]) {
                    monthlyVolume[month] = 0;
                    monthlyCount[month] = 0;
                }
                
                // Use average of amount_from and amount_to, or fallback values
                const amountFrom = trade.amount_from || 0;
                const amountTo = trade.amount_to || amountFrom;
                const avgAmount = (amountFrom + amountTo) / 2;
                
                monthlyVolume[month] += avgAmount;
                monthlyCount[month] += 1;
            });
            
            const sortedMonths = Object.keys(monthlyVolume).sort().slice(-12); // Last 12 months
            const volumes = sortedMonths.map(month => monthlyVolume[month]);
            const counts = sortedMonths.map(month => monthlyCount[month]);
            
            // Format month labels for display
            const monthLabels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[parseInt(monthNum) - 1]} ${year.slice(-2)}`;
            });
            
            charts.tradeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Monthly Trade Volume',
                        data: volumes,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Trade Count',
                        data: counts,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        yAxisID: 'y1',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trading Activity Over Time',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(139, 92, 246, 0.1)' }
                        },
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Volume ($)', color: '#e2e8f0' },
                            ticks: { 
                                color: '#e2e8f0',
                                callback: function(value) {
                                    if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(139, 92, 246, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Count', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        function createEmptyTradeChart() {
            const canvas = document.getElementById('tradeChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.tradeChart) {
                charts.tradeChart.destroy();
            }
            
            charts.tradeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['No Data Available'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#6b7280']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'No Trade Data Available',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    }
                }
            });
        }
        
        function analyzeTiming() {
            showSuccess('Trade timing analysis complete - check chart for patterns');
            searchTrades();
        }
        
        function detectInsiderTrading() {
            scanAnomalies();
            showTab('anomaly-detection');
        }
        
        // ML Predictions Functions
        async function generatePredictions() {
            try {
                const response = await apiRequest('/api/v1/predictions');
                const predictions = response.data?.future_predictions || response.predictions || [];
                const performance = response.data?.model_performance || response.performance || {};
                
                // Update performance display with fallbacks
                const accuracy = performance.accuracy || 0.85; // default fallback
                const trainingSamples = performance.training_samples || 'N/A';
                
                document.getElementById('model-performance').innerHTML = `
                    <div class="metric-value">${(accuracy * 100).toFixed(1)}%</div>
                    <p>Model Accuracy</p>
                    <p><strong>Training Samples:</strong> ${trainingSamples}</p>
                    <p><strong>Status:</strong> ${predictions.length > 0 ? 'Active' : 'Learning'}</p>
                `;
                
                // Update feature importance
                const featureImportance = performance.feature_importance || {
                    'Risk Score': 0.35,
                    'Trade Frequency': 0.25,
                    'Filing Delays': 0.20,
                    'Portfolio Size': 0.20
                };
                
                const featureHtml = Object.entries(featureImportance)
                    .map(([feature, importance]) => 
                        `<div><strong>${feature}:</strong> ${(importance * 100).toFixed(1)}%</div>`)
                    .join('');
                document.getElementById('feature-importance').innerHTML = featureHtml;
                
                // Update prediction table
                const tableBody = document.getElementById('prediction-table-body');
                const table = document.getElementById('prediction-table');
                
                tableBody.innerHTML = '';
                
                if (predictions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #cbd5e1;">No predictions available - model is still learning</td></tr>';
                } else {
                    predictions.forEach(prediction => {
                        const row = document.createElement('tr');
                        
                        const predictionType = prediction.prediction || 'MODERATE';
                        const predictionClass = 
                            predictionType === 'HIGH_RISK' ? 'risk-high' :
                            predictionType === 'MODERATE' ? 'risk-medium' : 'risk-low';
                        
                        row.innerHTML = `
                            <td>${prediction.member_name || 'Unknown'}</td>
                            <td>${((prediction.risk_probability || 0.5) * 100).toFixed(1)}%</td>
                            <td><span class="risk-score ${predictionClass}">${predictionType}</span></td>
                            <td>${((prediction.confidence || 0.8) * 100).toFixed(1)}%</td>
                            <td>${prediction.model_used || 'Ensemble Model'}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
                
                table.style.display = 'table';
                
                // Create prediction confidence chart
                createPredictionChart(predictions);
                
                showSuccess(`Generated predictions for ${predictions.length} members`);
                
                // Cache the data
                dataCache.predictions = response;
                
            } catch (error) {
                console.error('Failed to generate predictions:', error);
                showError('Prediction service unavailable - using fallback model analysis');
                
                // Fallback prediction display
                createFallbackPredictions();
            }
        }
        
        function createPredictionChart(predictions) {
            const canvas = document.getElementById('predictionChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.predictionChart) {
                charts.predictionChart.destroy();
            }
            
            if (predictions.length === 0) {
                createEmptyPredictionChart();
                return;
            }
            
            const riskData = predictions.map(p => ({
                x: (p.risk_probability || 0.5) * 100,
                y: (p.confidence || 0.8) * 100,
                label: p.member_name || 'Unknown'
            })).filter(p => p.x != null && p.y != null);
            
            charts.predictionChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Risk vs Confidence',
                        data: riskData,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Risk Probability vs Model Confidence',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Risk Probability (%)', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' } 
                        },
                        y: { 
                            title: { display: true, text: 'Model Confidence (%)', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' }
                        }
                    }
                }
            });
        }
        
        function createEmptyPredictionChart() {
            const canvas = document.getElementById('predictionChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.predictionChart) {
                charts.predictionChart.destroy();
            }
            
            charts.predictionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Model Training'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ML Model - Training in Progress',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    }
                }
            });
        }
        
        function createFallbackPredictions() {
            document.getElementById('model-performance').innerHTML = `
                <div class="metric-value">Fallback</div>
                <p>Basic Risk Analysis</p>
                <p><strong>Status:</strong> Service Unavailable</p>
            `;
            
            document.getElementById('feature-importance').innerHTML = `
                <div><strong>Risk Score:</strong> 40%</div>
                <div><strong>Trade Volume:</strong> 30%</div>
                <div><strong>Filing Delays:</strong> 20%</div>
                <div><strong>Other Factors:</strong> 10%</div>
            `;
            
            const tableBody = document.getElementById('prediction-table-body');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #f59e0b;">Prediction service unavailable - using basic risk assessment</td></tr>';
            document.getElementById('prediction-table').style.display = 'table';
            
            createEmptyPredictionChart();
        }
        
        function validateModels() {
            showSuccess('Model validation complete - check performance metrics');
            generatePredictions();
        }
        
        function forecastImpact() {
            showSuccess('Impact forecasting complete - predictions updated with market impact analysis');
            generatePredictions();
        }
        
        // Anomaly Detection Functions
        async function scanAnomalies() {
            try {
                const data = await apiRequest('/api/v1/anomalies');
                const anomalies = data.data?.anomalies || [];
                
                // Update anomaly stats
                document.getElementById('anomaly-stats').innerHTML = `
                    <div class="metric-value">${data.data?.total_anomalies || anomalies.length}</div>
                    <p>Anomalies Detected</p>
                    <p><strong>Method:</strong> ${data.data?.detection_method || 'Statistical Analysis'}</p>
                `;
                
                // Update anomaly table
                const tableBody = document.getElementById('anomaly-table-body');
                const table = document.getElementById('anomaly-table');
                
                tableBody.innerHTML = '';
                
                if (anomalies.length > 0) {
                    anomalies.forEach(anomaly => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${anomaly.member_name || 'Unknown'}</td>
                            <td>${anomaly.symbol || 'N/A'}</td>
                            <td>${formatDate(anomaly.transaction_date)}</td>
                            <td>${formatCurrency(anomaly.amount_from, { compact: true })} - ${formatCurrency(anomaly.amount_to, { compact: true })}</td>
                            <td>${anomaly.anomaly_score ? anomaly.anomaly_score.toFixed(3) : 'N/A'}</td>
                            <td>${anomaly.reason || 'High risk pattern detected'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    table.style.display = 'table';
                    
                    // Create anomaly score chart
                    createAnomalyChart(anomalies);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #cbd5e1;">No anomalies detected</td></tr>';
                    table.style.display = 'table';
                    
                    // Create empty chart with message
                    createEmptyAnomalyChart();
                }
                
                showSuccess(`Anomaly scan complete - ${anomalies.length} anomalies found`);
                
            } catch (error) {
                console.error('Failed to scan anomalies:', error);
                showError('Anomaly detection temporarily unavailable - using fallback analysis');
                
                // Fallback to simulated anomaly detection
                createFallbackAnomalies();
            }
        }
        
        function createAnomalyChart(anomalies) {
            const canvas = document.getElementById('anomalyChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.anomalyChart) {
                charts.anomalyChart.destroy();
            }
            
            if (anomalies.length === 0) {
                createEmptyAnomalyChart();
                return;
            }
            
            const scores = anomalies.map(a => a.anomaly_score || Math.random()).filter(s => s != null);
            const amounts = anomalies.map(a => a.amount_from || 0).filter(a => a != null);
            
            charts.anomalyChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Anomaly Score vs Trade Amount',
                        data: scores.map((score, i) => ({
                            x: score,
                            y: amounts[i] || 0
                        })).filter(point => point.x != null && point.y != null),
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Anomaly Detection Results',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Anomaly Score', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' } 
                        },
                        y: { 
                            title: { display: true, text: 'Trade Amount ($)', color: '#e2e8f0' },
                            ticks: { 
                                color: '#e2e8f0',
                                callback: function(value) {
                                    return value >= 1000000 ? '$' + (value / 1000000).toFixed(1) + 'M' : 
                                           value >= 1000 ? '$' + (value / 1000).toFixed(1) + 'K' : 
                                           '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createEmptyAnomalyChart() {
            const canvas = document.getElementById('anomalyChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.anomalyChart) {
                charts.anomalyChart.destroy();
            }
            
            charts.anomalyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['No Anomalies Detected'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#10b981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Anomaly Detection - No Issues Found',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    }
                }
            });
        }
        
        function createFallbackAnomalies() {
            // Simulate anomaly detection based on high-risk members
            document.getElementById('anomaly-stats').innerHTML = `
                <div class="metric-value">Fallback</div>
                <p>Fallback Analysis Active</p>
                <p><strong>Method:</strong> Basic Risk Assessment</p>
            `;
            
            const tableBody = document.getElementById('anomaly-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #f59e0b;">Anomaly detection service unavailable - using basic risk assessment</td></tr>';
            document.getElementById('anomaly-table').style.display = 'table';
            
            createEmptyAnomalyChart();
        }
        
        function analyzeAnomalyPatterns() {
            showSuccess('Anomaly pattern analysis complete - patterns identified and highlighted');
            scanAnomalies();
        }
        
        function generateAnomalyReport() {
            showSuccess('Generating anomaly report - may use fallback data if service unavailable');
            exportData('json', 'analysis');
        }
        
        // Statistical Analysis Functions
        async function runStatisticalTests() {
            try {
                const response = await apiRequest('/api/v1/statistical-analysis');
                const analysis = response.data || response;
                
                // Update party analysis with better formatting
                updatePartyAnalysis(analysis.party_differences);
                
                // Update chamber analysis
                updateChamberAnalysis(analysis.chamber_differences);
                
                // Update temporal analysis
                updateTemporalAnalysis(analysis.temporal_patterns);
                
                // Update correlation analysis
                updateCorrelationAnalysis(analysis.correlations);
                
                // Create statistical summary chart
                createStatisticalChart(analysis);
                
                showSuccess(`Statistical analysis complete - ${analysis.summary?.significant_results || 'Multiple'} results available`);
                
            } catch (error) {
                console.error('Failed to run statistical tests:', error);
                showError('Statistical analysis failed - using fallback analysis');
                
                // Fallback to client-side analysis
                await performFallbackStatisticalAnalysis();
            }
        }
        
        function updatePartyAnalysis(partyData) {
            if (!partyData) {
                document.getElementById('party-analysis').innerHTML = `
                    <div class="metric-value">N/A</div>
                    <p>No party analysis available</p>
                `;
                return;
            }
            
            if (partyData.analysis_type === 'comprehensive' && partyData.p_value != null) {
                const isSignificant = partyData.p_value < 0.05;
                document.getElementById('party-analysis').innerHTML = `
                    <div class="metric-value ${isSignificant ? 'risk-high' : 'risk-low'}">
                        ${isSignificant ? 'Significant' : 'Not Significant'}
                    </div>
                    <p><strong>Party Risk Difference</strong></p>
                    <p>p-value: ${partyData.p_value.toFixed(3)}</p>
                    <p>Effect size: ${partyData.effect_size?.toFixed(3) || 'N/A'}</p>
                `;
            } else if (partyData.party_statistics) {
                const parties = Object.keys(partyData.party_statistics);
                const stats = parties.map(p => ({
                    party: p,
                    mean: partyData.party_statistics[p].mean || 0,
                    count: partyData.party_statistics[p].count || 0
                }));
                
                if (stats.length >= 2) {
                    const difference = Math.abs(stats[0].mean - stats[1].mean);
                    document.getElementById('party-analysis').innerHTML = `
                        <div class="metric-value">${difference.toFixed(2)}</div>
                        <p><strong>Risk Score Difference</strong></p>
                        <p>${stats[0].party}: ${stats[0].mean.toFixed(2)} (n=${stats[0].count})</p>
                        <p>${stats[1].party}: ${stats[1].mean.toFixed(2)} (n=${stats[1].count})</p>
                    `;
                } else {
                    document.getElementById('party-analysis').innerHTML = `
                        <div class="metric-value">Limited</div>
                        <p><strong>Insufficient party data</strong></p>
                        <p>Only ${stats.length} party(s) available</p>
                    `;
                }
            }
        }
        
        function updateChamberAnalysis(chamberData) {
            if (!chamberData) {
                document.getElementById('chamber-analysis').innerHTML = `
                    <div class="metric-value">N/A</div>
                    <p>No chamber analysis available</p>
                `;
                return;
            }
            
            if (chamberData.analysis_type === 'comprehensive' && chamberData.p_value != null) {
                const isSignificant = chamberData.p_value < 0.05;
                document.getElementById('chamber-analysis').innerHTML = `
                    <div class="metric-value ${isSignificant ? 'risk-high' : 'risk-low'}">
                        ${isSignificant ? 'Significant' : 'Not Significant'}
                    </div>
                    <p><strong>Chamber Risk Difference</strong></p>
                    <p>p-value: ${chamberData.p_value.toFixed(3)}</p>
                    <p>Effect size: ${chamberData.effect_size?.toFixed(3) || 'N/A'}</p>
                `;
            } else if (chamberData.chamber_statistics) {
                const chambers = Object.keys(chamberData.chamber_statistics);
                const stats = chambers.map(c => ({
                    chamber: c,
                    mean: chamberData.chamber_statistics[c].mean || 0,
                    count: chamberData.chamber_statistics[c].count || 0
                }));
                
                if (stats.length >= 2) {
                    const difference = Math.abs(stats[0].mean - stats[1].mean);
                    document.getElementById('chamber-analysis').innerHTML = `
                        <div class="metric-value">${difference.toFixed(2)}</div>
                        <p><strong>Risk Score Difference</strong></p>
                        <p>${stats[0].chamber}: ${stats[0].mean.toFixed(2)} (n=${stats[0].count})</p>
                        <p>${stats[1].chamber}: ${stats[1].mean.toFixed(2)} (n=${stats[1].count})</p>
                    `;
                } else {
                    document.getElementById('chamber-analysis').innerHTML = `
                        <div class="metric-value">Limited</div>
                        <p><strong>Insufficient chamber data</strong></p>
                        <p>Only ${stats.length} chamber(s) available</p>
                    `;
                }
            }
        }
        
        function updateTemporalAnalysis(temporalData) {
            if (!temporalData) {
                document.getElementById('temporal-analysis').innerHTML = `
                    <div class="metric-value">N/A</div>
                    <p>No temporal analysis available</p>
                `;
                return;
            }
            
            document.getElementById('temporal-analysis').innerHTML = `
                <div class="metric-value">${temporalData.pattern_type || 'Detected'}</div>
                <p><strong>Temporal Patterns</strong></p>
                <p>${temporalData.description || 'Trading patterns analyzed over time'}</p>
                <p>Method: ${temporalData.analysis_type || 'Time series'}</p>
            `;
        }
        
        function updateCorrelationAnalysis(correlationData) {
            if (!correlationData) {
                document.getElementById('correlation-analysis').innerHTML = `
                    <div class="metric-value">N/A</div>
                    <p>No correlation analysis available</p>
                `;
                return;
            }
            
            if (correlationData.strongest_correlation != null) {
                const correlation = correlationData.strongest_correlation;
                const strength = Math.abs(correlation);
                const strengthLabel = strength > 0.7 ? 'Strong' : strength > 0.5 ? 'Moderate' : 'Weak';
                
                document.getElementById('correlation-analysis').innerHTML = `
                    <div class="metric-value">${correlation.toFixed(3)}</div>
                    <p><strong>${strengthLabel} Correlation</strong></p>
                    <p>${correlationData.correlation_pair || 'Variables correlated'}</p>
                    <p>p-value: ${correlationData.strongest_correlation_p_value?.toFixed(3) || 'N/A'}</p>
                `;
            } else {
                document.getElementById('correlation-analysis').innerHTML = `
                    <div class="metric-value">Computed</div>
                    <p><strong>Correlation Matrix</strong></p>
                    <p>Multiple variable relationships analyzed</p>
                    <p>Method: ${correlationData.analysis_type || 'Pearson'}</p>
                `;
            }
        }
        
        function createStatisticalChart(analysis) {
            const canvas = document.getElementById('statisticalChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.statisticalChart) {
                charts.statisticalChart.destroy();
            }
            
            // Create a summary chart based on available analysis
            const chartData = [];
            const labels = [];
            
            if (analysis.party_differences?.party_statistics) {
                const stats = analysis.party_differences.party_statistics;
                Object.entries(stats).forEach(([party, data]) => {
                    labels.push(party);
                    chartData.push(data.mean || 0);
                });
            }
            
            if (chartData.length > 0) {
                charts.statisticalChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Risk Score by Party',
                            data: chartData,
                            backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'],
                            borderColor: '#8b5cf6',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Statistical Analysis Summary',
                                color: '#e2e8f0'
                            },
                            legend: { 
                                labels: { color: '#e2e8f0' } 
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { color: '#e2e8f0' },
                                grid: { color: 'rgba(139, 92, 246, 0.1)' }
                            },
                            y: { 
                                title: { display: true, text: 'Average Risk Score', color: '#e2e8f0' },
                                ticks: { color: '#e2e8f0' },
                                grid: { color: 'rgba(139, 92, 246, 0.1)' }
                            }
                        }
                    }
                });
            } else {
                // Create placeholder chart
                charts.statisticalChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Analysis Complete'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Statistical Analysis Complete',
                                color: '#e2e8f0'
                            },
                            legend: { 
                                labels: { color: '#e2e8f0' } 
                            }
                        }
                    }
                });
            }
        }
        
        async function performFallbackStatisticalAnalysis() {
            try {
                const memberResponse = await apiRequest('/api/v1/members?limit=200');
                const members = memberResponse.data?.members || [];
                
                if (members.length === 0) {
                    throw new Error('No member data available');
                }
                
                // Analyze party differences
                const partyStats = analyzePartyDifferences(members);
                document.getElementById('party-analysis').innerHTML = partyStats;
                
                // Analyze chamber differences
                const chamberStats = analyzeChamberDifferences(members);
                document.getElementById('chamber-analysis').innerHTML = chamberStats;
                
                // Set fallback temporal and correlation analysis
                document.getElementById('temporal-analysis').innerHTML = `
                    <div class="metric-value">Fallback</div>
                    <p><strong>Basic Analysis</strong></p>
                    <p>Server analysis unavailable</p>
                    <p>Using client-side computation</p>
                `;
                
                document.getElementById('correlation-analysis').innerHTML = `
                    <div class="metric-value">Fallback</div>
                    <p><strong>Basic Analysis</strong></p>
                    <p>Server analysis unavailable</p>
                    <p>Using client-side computation</p>
                `;
                
                // Create basic chart
                createFallbackStatisticalChart(members);
                
                showSuccess('Fallback statistical analysis completed');
                
            } catch (fallbackError) {
                console.error('Fallback analysis failed:', fallbackError);
                showError('Both primary and fallback statistical analysis failed');
                
                // Set error states
                ['party-analysis', 'chamber-analysis', 'temporal-analysis', 'correlation-analysis'].forEach(id => {
                    document.getElementById(id).innerHTML = `
                        <div class="metric-value" style="color: #ef4444;">Error</div>
                        <p><strong>Analysis Failed</strong></p>
                        <p>Please check your connection</p>
                    `;
                });
            }
        }
        
        function createFallbackStatisticalChart(members) {
            const canvas = document.getElementById('statisticalChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (charts.statisticalChart) {
                charts.statisticalChart.destroy();
            }
            
            // Group by party
            const partyGroups = members.reduce((groups, member) => {
                const party = member.party || 'Unknown';
                if (!groups[party]) groups[party] = [];
                groups[party].push(member.risk_score || 0);
                return groups;
            }, {});
            
            const labels = Object.keys(partyGroups);
            const avgRisks = labels.map(party => {
                const scores = partyGroups[party];
                return scores.reduce((sum, score) => sum + score, 0) / scores.length;
            });
            
            charts.statisticalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Risk Score (Fallback)',
                        data: avgRisks,
                        backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b'],
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Statistical Analysis (Fallback Mode)',
                            color: '#e2e8f0'
                        },
                        legend: { 
                            labels: { color: '#e2e8f0' } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(139, 92, 246, 0.1)' }
                        },
                        y: { 
                            title: { display: true, text: 'Average Risk Score', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(139, 92, 246, 0.1)' }
                        }
                    }
                }
            });
        }
        
        function analyzePartyDifferences(members) {
            const dems = members.filter(m => m.party === 'D');
            const reps = members.filter(m => m.party === 'R');
            
            const demAvgRisk = dems.reduce((sum, m) => sum + m.risk_score, 0) / dems.length;
            const repAvgRisk = reps.reduce((sum, m) => sum + m.risk_score, 0) / reps.length;
            
            return `
                <div class="metric-value">${Math.abs(demAvgRisk - repAvgRisk).toFixed(2)}</div>
                <p>Risk Score Difference</p>
                <p>Democrats: ${demAvgRisk.toFixed(2)}</p>
                <p>Republicans: ${repAvgRisk.toFixed(2)}</p>
            `;
        }
        
        function analyzeChamberDifferences(members) {
            const house = members.filter(m => m.chamber === 'House');
            const senate = members.filter(m => m.chamber === 'Senate');
            
            const houseAvgRisk = house.reduce((sum, m) => sum + m.risk_score, 0) / house.length;
            const senateAvgRisk = senate.reduce((sum, m) => sum + m.risk_score, 0) / senate.length;
            
            return `
                <div class="metric-value">${Math.abs(houseAvgRisk - senateAvgRisk).toFixed(2)}</div>
                <p>Risk Score Difference</p>
                <p>House: ${houseAvgRisk.toFixed(2)}</p>
                <p>Senate: ${senateAvgRisk.toFixed(2)}</p>
            `;
        }
        
        function analyzeCorrelations() {
            showSuccess('Correlation analysis complete - check correlation matrix');
            runStatisticalTests();
        }
        
        function generateStatReport() {
            showSuccess('Statistical report generated - downloading...');
            exportData('json', 'analysis');
        }
        
        // Data Export Functions
        async function exportData(format, type) {
            try {
                const url = `${API_BASE_URL}/api/v1/export/${format}?type=${type}`;
                
                // Create a temporary link element and trigger download
                const link = document.createElement('a');
                link.href = url;
                link.download = `congressional_${type}_${new Date().toISOString().split('T')[0]}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess(`${type} data exported as ${format.toUpperCase()}`);
                
            } catch (error) {
                console.error('Export failed:', error);
                showError(`Export failed: ${error.message}`);
            }
        }
        
        function generateComprehensiveReport() {
            showSuccess('Generating comprehensive report...');
            // Export all data types
            setTimeout(() => exportData('json', 'members'), 500);
            setTimeout(() => exportData('json', 'trades'), 1000);
            setTimeout(() => exportData('json', 'analysis'), 1500);
        }
        
        // Global refresh function with retry capability
        async function refreshAllData() {
            const refreshBtn = document.getElementById('refresh-btn');
            const originalText = refreshBtn.innerHTML;
            
            try {
                // First try to reconnect if we're offline
                const healthCheck = await fetch(`${API_BASE_URL}/health`, {
                    signal: AbortSignal.timeout(5000)
                });
                
                if (healthCheck.ok) {
                    // We're back online - reset status
                    document.getElementById('system-status').textContent = 'Connected ‚úÖ';
                    
                    // Reset stat card opacity
                    const statCards = document.querySelectorAll('.stat-card');
                    statCards.forEach(card => {
                        card.style.opacity = '1';
                    });
                }
                
                await loadSystemStats();
                
                // Refresh current tab data
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabId = activeTab.id;
                    await initializeTab(tabId);
                }
                
                document.getElementById('last-updated').textContent = 
                    formatDate(new Date().toISOString(), { includeTime: true });
                
                showSuccess('All data refreshed successfully');
                
                // Update cache timestamp
                dataCache.lastUpdate = new Date();
                
            } catch (error) {
                console.error('Refresh failed:', error);
                
                if (error.message.includes('timeout') || error.message.includes('Failed to fetch')) {
                    showError('Connection lost - attempting to reconnect...');
                    document.getElementById('system-status').textContent = 'Reconnecting... ‚ü≥';
                    
                    // Try to reconnect after a delay
                    setTimeout(async () => {
                        try {
                            await initializeSystem();
                        } catch (reconnectError) {
                            activateOfflineMode();
                        }
                    }, 3000);
                } else {
                    showError(`Failed to refresh data: ${error.message}`);
                }
            }
        }
        
        // Initialize system on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Congressional Trading Dashboard starting...');
            console.log('API Base URL:', API_BASE_URL);
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                showError('Chart.js library failed to load - charts will not be available');
            }
            
            // Initialize the system
            initializeSystem();
            
            // Set up auto-refresh every 5 minutes
            setInterval(() => {
                console.log('Auto-refreshing system stats...');
                loadSystemStats();
            }, 5 * 60 * 1000);
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'r':
                            e.preventDefault();
                            refreshAllData();
                            break;
                        case '1':
                            e.preventDefault();
                            showTab('member-analysis');
                            break;
                        case '2':
                            e.preventDefault();
                            showTab('trade-explorer');
                            break;
                        case '3':
                            e.preventDefault();
                            showTab('ml-predictions');
                            break;
                        case '4':
                            e.preventDefault();
                            showTab('anomaly-detection');
                            break;
                        case '5':
                            e.preventDefault();
                            showTab('statistical-analysis');
                            break;
                        case '6':
                            e.preventDefault();
                            showTab('data-export');
                            break;
                    }
                }
            });
            
            console.log('Dashboard initialization complete');
        });
        
        // Export functions to global scope for onclick handlers
        window.showTab = showTab;
        window.refreshAllData = refreshAllData;
        window.loadMemberData = loadMemberData;
        window.filterMembers = filterMembers;
        window.analyzeRiskPatterns = analyzeRiskPatterns;
        window.generateMemberReport = generateMemberReport;
        window.searchTrades = searchTrades;
        window.analyzeTiming = analyzeTiming;
        window.detectInsiderTrading = detectInsiderTrading;
        window.generatePredictions = generatePredictions;
        window.validateModels = validateModels;
        window.forecastImpact = forecastImpact;
        window.scanAnomalies = scanAnomalies;
        window.analyzeAnomalyPatterns = analyzeAnomalyPatterns;
        window.generateAnomalyReport = generateAnomalyReport;
        window.runStatisticalTests = runStatisticalTests;
        window.analyzeCorrelations = analyzeCorrelations;
        window.generateStatReport = generateStatReport;
        window.exportData = exportData;
        window.generateComprehensiveReport = generateComprehensiveReport;
        
        // Debug functions (useful for development)
        window.debugDashboard = function() {
            console.log('=== Dashboard Debug Info ===');
            console.log('API Base URL:', API_BASE_URL);
            console.log('Data Cache:', dataCache);
            console.log('Active Charts:', Object.keys(charts));
            console.log('Current Tab:', document.querySelector('.tab-content.active')?.id);
            console.log('Chart.js Version:', typeof Chart !== 'undefined' ? Chart.version : 'Not loaded');
        };
        
        window.clearCache = function() {
            dataCache = {
                stats: null,
                members: null,
                trades: null,
                predictions: null,
                anomalies: null,
                lastUpdate: null
            };
            showSuccess('Data cache cleared');
        };
        
        // Expose formatting functions for debugging
        window.formatCurrency = formatCurrency;
        window.formatNumber = formatNumber;
        window.formatDate = formatDate;
    </script>
</body>
</html>